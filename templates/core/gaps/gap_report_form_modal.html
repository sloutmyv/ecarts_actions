<!-- Modale pour formulaire de déclaration d'écart -->
<div id="gap-report-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <!-- En-tête de la modale -->
        <div class="flex items-center justify-between p-6 border-b border-gray-200">
            <h2 class="text-xl font-semibold text-gray-900 flex items-center gap-2">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
                Déclarer un écart
            </h2>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Formulaire -->
        <form 
            hx-post="{% url 'gaps:gap_report_create' %}"
            hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
            class="p-6">
            
            <!-- Section QUI ? -->
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm font-bold">QUI ?</span>
                    Personnes présentes lors de l'observation
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Autres personnes présentes (gauche) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            Autres personnes présentes <span class="text-xs text-gray-500 font-normal">(optionnel)</span>
                        </label>
                        
                        <!-- Champ de recherche compact -->
                        <div class="mb-3">
                            <input 
                                type="text" 
                                id="involved_users_search" 
                                placeholder="Matricule, nom, prénom..."
                                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <!-- Résultats de recherche compacts -->
                        <div id="search-results" class="mb-3 max-h-28 overflow-y-auto border border-gray-200 rounded-md hidden text-sm">
                            <!-- Sera rempli par JavaScript -->
                        </div>
                        
                        <!-- Personnes sélectionnées compactes -->
                        <div id="selected-users" class="space-y-2">
                            <!-- Sera rempli par JavaScript -->
                        </div>
                        
                        <!-- Champ caché pour les IDs sélectionnés -->
                        <input type="hidden" name="involved_users" id="involved_users_ids" value="">
                    </div>
                    
                    <!-- Déclarant (droite) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            Déclarant
                        </label>
                        <div class="bg-blue-50 border border-blue-200 rounded-md p-4">
                            <div class="flex items-center gap-2">
                                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                                <div>
                                    <div class="font-medium text-blue-900">
                                        {{ user.get_full_name|default:user.matricule }}
                                    </div>
                                    {% if user.matricule %}
                                    <div class="text-sm text-blue-700">{{ user.matricule }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Source d'audit -->
                <div>
                    <label for="audit_source" class="block text-sm font-medium text-gray-700 mb-2">
                        Source de l'audit <span class="text-red-500">*</span>
                    </label>
                    <select 
                        id="audit_source" 
                        name="audit_source"
                        required
                        hx-get="{% url 'gaps:get_process_field' %}"
                        hx-target="#process-field"
                        hx-include="[name='audit_source']"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Sélectionner une source</option>
                        {% for source in audit_sources %}
                            <option value="{{ source.id }}">{{ source.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Référence source -->
                <div>
                    <label for="source_reference" class="block text-sm font-medium text-gray-700 mb-2">
                        Référence source
                    </label>
                    <input 
                        type="text" 
                        id="source_reference" 
                        name="source_reference" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Référence optionnelle">
                </div>

                <!-- Service concerné -->
                <div>
                    <label for="service" class="block text-sm font-medium text-gray-700 mb-2">
                        Service concerné <span class="text-red-500">*</span>
                        {% if user.service %}
                            <span class="text-xs text-blue-600 font-normal">(Votre service est pré-sélectionné)</span>
                        {% endif %}
                    </label>
                    <select 
                        id="service" 
                        name="service"
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Sélectionner un service</option>
                        {% for service in services %}
                            <option value="{{ service.id }}" {% if user.service and service.id == user.service.id %}selected{% endif %}>
                                {{ service.get_chemin_hierarchique }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Processus (champ dynamique) -->
                <div id="process-field">
                    <!-- Sera rempli dynamiquement via HTMX -->
                </div>

                <!-- Lieu -->
                <div>
                    <label for="location" class="block text-sm font-medium text-gray-700 mb-2">
                        Lieu
                    </label>
                    <input 
                        type="text" 
                        id="location" 
                        name="location" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Lieu de l'observation">
                </div>

                <!-- Date d'observation -->
                <div>
                    <label for="observation_date" class="block text-sm font-medium text-gray-700 mb-2">
                        Date d'observation <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="date" 
                        id="observation_date" 
                        name="observation_date" 
                        value="{{ 'today'|date:'Y-m-d' }}"
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>


            <!-- Boutons d'action -->
            <div class="flex justify-end gap-3 mt-8 pt-6 border-t border-gray-200">
                <button 
                    type="button" 
                    onclick="closeModal()"
                    class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                    Annuler
                </button>
                <button 
                    type="submit"
                    class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                    Créer la déclaration
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Ouvrir automatiquement la modale
    setTimeout(() => {
        const modal = document.querySelector('#gap-report-modal');
        if (modal) {
            modal.classList.remove('hidden');
        }
    }, 100);
    
    // Données des utilisateurs pour la recherche
    const allUsers = [
        {% for user_item in users %}
        {
            id: {{ user_item.id }},
            matricule: '{{ user_item.matricule|default:"" }}',
            nom: '{{ user_item.nom|default:"" }}',
            prenom: '{{ user_item.prenom|default:"" }}',
            service: '{% if user_item.service %}{{ user_item.service.nom }}{% endif %}',
            fullName: '{{ user_item.get_full_name|escapejs }}'
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    const connectedUserId = {{ user.id }};
    
    // Gestion de la recherche d'utilisateurs
    let selectedUsers = [];
    
    function initUserSearch() {
        const searchInput = document.getElementById('involved_users_search');
        const resultsDiv = document.getElementById('search-results');
        
        searchInput.addEventListener('input', function() {
            const term = this.value.toLowerCase().trim();
            
            if (term.length < 2) {
                resultsDiv.classList.add('hidden');
                return;
            }
            
            const filteredUsers = allUsers.filter(user => {
                // Exclure l'utilisateur connecté et les utilisateurs déjà sélectionnés
                if (user.id === connectedUserId || selectedUsers.includes(user.id)) {
                    return false;
                }
                
                const searchableText = (user.matricule + ' ' + user.nom + ' ' + user.prenom + ' ' + user.fullName).toLowerCase();
                return searchableText.includes(term);
            });
            
            displaySearchResults(filteredUsers);
        });
        
        // Initialiser l'affichage
        updateSelectedUsersDisplay();
    }
    
    function displaySearchResults(users) {
        const results = document.getElementById('search-results');
        
        if (users.length === 0) {
            results.innerHTML = '<div class="p-2 text-gray-500 text-sm">Aucun utilisateur trouvé</div>';
        } else {
            results.innerHTML = users.map(user => {
                const matriculeText = user.matricule ? user.matricule : '';
                return `<div class="p-2 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0" onclick="addUser(${user.id})">
                    <div class="text-sm font-medium text-gray-900">${user.fullName}</div>
                    <div class="text-xs text-gray-600">${matriculeText}</div>
                </div>`;
            }).join('');
        }
        
        results.classList.remove('hidden');
    }
    
    function addUser(userId) {
        const user = allUsers.find(u => u.id === userId);
        if (user && !selectedUsers.includes(userId)) {
            selectedUsers.push(userId);
            updateSelectedUsersDisplay();
            updateHiddenField();
            document.getElementById('involved_users_search').value = '';
            document.getElementById('search-results').classList.add('hidden');
        }
    }
    
    function removeUser(userId) {
        selectedUsers = selectedUsers.filter(id => id !== userId);
        updateSelectedUsersDisplay();
        updateHiddenField();
    }
    
    function updateSelectedUsersDisplay() {
        const container = document.getElementById('selected-users');
        const selectedUsersData = selectedUsers.map(id => allUsers.find(u => u.id === id));
        
        if (selectedUsersData.length === 0) {
            container.innerHTML = '<div class="text-sm text-gray-500 italic">Aucune personne ajoutée</div>';
        } else {
            container.innerHTML = selectedUsersData.map(user => {
                const matriculeText = user.matricule ? user.matricule : '';
                return `<div class="flex items-center justify-between bg-gray-50 border border-gray-200 rounded-md p-2">
                    <div class="text-sm">
                        <div class="font-medium text-gray-900">${user.fullName}</div>
                        <div class="text-xs text-gray-600">${matriculeText}</div>
                    </div>
                    <button type="button" onclick="removeUser(${user.id})" 
                            class="text-red-500 hover:text-red-700 text-xs">
                        ✕
                    </button>
                </div>`;
            }).join('');
        }
    }
    
    function updateHiddenField() {
        document.getElementById('involved_users_ids').value = selectedUsers.join(',');
    }
    
    // Initialiser la recherche après ouverture de la modale
    setTimeout(() => {
        initUserSearch();
    }, 200);
    
    // Fermer les résultats de recherche en cliquant ailleurs
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#involved_users_search') && !e.target.closest('#search-results')) {
            document.getElementById('search-results').classList.add('hidden');
        }
    });
</script>